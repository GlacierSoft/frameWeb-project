!function(a,b){function c(c,d){return a.array.filter(c,function(a){var c=null==a.tierNo||a.tierNo==b?0:window.parseInt(a.tierNo);return 0/0==c&&(c=0),d?c>80:c>0&&80>=c})}function d(b){var i,j,c=a.array.map(b,function(a){return a.tierNo}),d=a.array.reduce(b,function(b,c){var d=a.array.map(c.bays,function(a){return a.rowNo});return a.array.merge(b,d)},[]),e=a.array.min(d)||0,f=a.array.max(d)||0,g=a.array.min(c)||0,h=a.array.max(c)||0;return e=parseInt(e),f=parseInt(f),g=parseInt(g),h=parseInt(h),a.number.isOdd(f)&&f++,i=f,j=h>80?h-80:h,{x:"00"==e?i+1:i,y:j/2}}function e(a,b){return{x:Math.max(a.x,b.x),y:a.y+b.y}}function f(b,f,i){if(!i||!a.isArray(i.tiers)||!i.tiers.length)return window.alert("初始化贝位 "+i.title+" 的网格布局图失败，其属性 tiers 不是一个数组对象或没有任何数据");var j=c(i.tiers,!0),k=c(i.tiers,!1),l=d(j),m=d(k),n=e(l,m),o=n.x*(a.baygui.defaults.cell.width+1)+a.baygui.defaults.cell.ruleYW+5,p=n.y*a.baygui.defaults.cell.height+2*a.baygui.defaults.cell.ruleXH+15,q=l.y*a.baygui.defaults.cell.height+a.baygui.defaults.cell.ruleXH+10,r=f.panel("body"),s=a('<div style="width: '+o+"px; height: "+p+'px;">'+"<div data-options=\"region: 'north', split: true, minHeight: "+q+", maxHeight: "+q+', border: false" style="height: '+q+'px; border-bottom-width: 1px;"></div>'+'<div data-options="region: \'center\', border: false" style="border-top-width: 1px;"></div>'+"</div>").appendTo(r).layout({fit:!1}),t=s.layout("panel","north").panel("body"),u=s.layout("panel","center").panel("body"),v=f.panel("options"),w=v.onResize;v.onResize=function(b,c){a.isFunction(w)&&w.apply(this,arguments),s.css({width:Math.max(o,b-3),height:Math.max(p,c-3)}).layout("resize")},f.panel("resize"),g(t,i,l,m,!0),g(u,i,m,l,!1),h(b,t,i,j),h(b,u,i,k)}function g(b,c,d,e,f){var j,k,l,m,n,o,p,q,r,g=a('<div class="bays-container"></div>').appendTo(b),h=a('<table class="bays-wrapper" cellpadding="0" cellspacing="0"></table>').attr("bayNo",c.bayNo).appendTo(g),i=a.number.isOdd(d.x);for(j=1;j<=d.y;j++){for(k=a.string.padLeft(2*j+(f?80:0),2,"0"),l=a('<tr class="bay-row"></tr>').attr("tierNo",k).prependTo(h),m=0;m<d.x;m++)n=i?m:m+1,o=a.number.isOdd(n)?"appendTo":"prependTo",n=a.string.padLeft(n,2,"0"),a('<td class="bay-cell"><div class="bay-cell-item"><span>&nbsp;</span></div></td>').attr("rowNo",n)[o](l);a('<td class="bay-cell bay-cell-ruley">&nbsp;</td>').text(k).prependTo(l)}for(p=a('<tr class="bay-row bay-cell-rulex"></tr>').prependTo(h),j=0;j<d.x;j++)n=i?j:j+1,q=a.string.padLeft(n,2,"0"),o=a.number.isOdd(n)?"appendTo":"prependTo",a('<td class="bay-cell"></td>').text(q)[o](p);if(a('<td class="bay-cell bay-cell-ruley">&nbsp;</td>').prependTo(p),r=e.x-d.x,r>0)for(j=r;j>0;j-=2)h.find("tr.bay-row").each(function(){var b=this,c=a(this),d=c.find("td.bay-cell-ruley"),e=a('<td class="bay-cell-indent"></td>').insertAfter(d),f=a('<td class="bay-cell-indent"></td>').appendTo(b);2>j&&(e.addClass("bay-cell-indent-half"),f.addClass("bay-cell-indent-half"))})}function h(b,d,e,f,g){f=f||c(e.tiers,g);var h=d.find("table.bays-wrapper"),i=e.bayNo;a.each(f,function(b,c){var d=c.tierNo,e=a.isArray(c.bays)?c.bays:[];d&&a.each(e,function(a,b){b.rowNo&&b.disabled&&h.find("tr[tierNo="+d+"] td[rowNo="+b.rowNo+"]").attr("disabled",!0).addClass("bay-cell-disabled")})}),h.find("tr[tierNo] td[rowNo]:not([disabled])").on({click:function(){var d=a(this),e=d.parent(),f=d.attr("rowNo"),g=e.attr("tierNo"),h=i+f+g;d.hasClass("bay-cell-selected")?b.unSelectCell():b.selectCell(h)},mouseover:function(){if(bayCellTooltip=b.bayCellTooltip?!0:!1){var c=a(this),d=M(b,c);c.tooltip({trackMouse:!0,onHide:function(){a.util.exec(function(){c.tooltip("destroy")})},onShow:function(){var e=a.isFunction(b.tooltipFormatter)?b.tooltipFormatter:a.baygui.defaults.tooltipFormatter,f=e.call(b,d.bayCellNo,d.box,d.bayCell);c.tooltip("update",f)}}).tooltip("show")}},contextmenu:function(c){var d,e,f,g;bayCellContextMenu=b.bayCellContextMenu?!0:!1,d=a(this),e=M(b,d),b.selectCell(e.bayCellNo),bayCellContextMenu&&(c.preventDefault(),f=b.boxesGrid.datagrid("getSelected"),g=[{text:function(){return f?"将箱 "+f.boxNo+" 装载此处":"设置贝位"},iconCls:"icon-hamburg-exchange",disabled:function(){return f?!1:!0},handler:function(){f&&b.setCell(e.bayCellNo,f.boxNo)}},"-",{text:"重置该贝位单元格",iconCls:"icon-hamburg-showreel",handler:function(){b.resetCell(e.bayCellNo)}},{text:"清除该贝位单元格",iconCls:"icon-standard-cancel",handler:function(){b.clearCell(e.bayCellNo)}},"-",{text:"重置当前贝位",iconCls:"icon-hamburg-settings",handler:function(){b.resetBay()}},{text:"清除当前贝位",iconCls:"icon-standard-cross",handler:function(){b.clearBay()}},"-",{text:"所选列位(纵向)装载总重",iconCls:"",handler:function(){var c=b.baysContainer.find("table.bays-wrapper[bayNo="+e.bayNo+"] td[rowNo="+e.rowNo+"]").map(function(){return M(b,a(this))}),d=a.array.some(c,function(a){return a.bayCell.hasClass("bay-cell-bigbox-next")}),f=a.array.sum(c,function(a){return a&&a.box&&a.box.boxWeight&&a.bayCell&&!a.bayCell.hasClass("bay-cell-bigbox-next")?a.box.boxWeight:0});a.messager.show("所选列位(纵向)装载总箱重为："+a.number.round(f,2)+(d?'<br/><span style="font-weight: bold; color: green">不包含在上一贝位配载的40\'箱重</span>':""))}},{text:"所选层位(横向)装载总重",iconCls:"",handler:function(){var c=b.baysContainer.find("table.bays-wrapper[bayNo="+e.bayNo+"] tr[tierNo="+e.tierNo+"] td[rowNo]").map(function(){return M(b,a(this))}),d=a.array.some(c,function(a){return a.bayCell.hasClass("bay-cell-bigbox-next")}),f=a.array.sum(c,function(a){return a&&a.box&&a.box.boxWeight&&a.bayCell&&!a.bayCell.hasClass("bay-cell-bigbox-next")?a.box.boxWeight:0});a.messager.show("所选层位(横向)装载总箱重为："+a.number.round(f,2)+(d?'<br/><span style="font-weight: bold; color: green">不包含在上一贝位配载的40\'箱重</span>':""))}},"-",{text:function(){return"所有贝位的"+e.rowNo+"行位(纵向)装载总重"},iconCls:"",handler:function(){var c=b.baysContainer.find("table.bays-wrapper[bayNo] td[rowNo="+e.rowNo+"]").map(function(){return M(b,a(this))}),d=a.array.sum(c,function(a){return a&&a.box&&a.box.boxWeight&&a.bayCell&&!a.bayCell.hasClass("bay-cell-bigbox-next")?a.box.boxWeight:0});a.messager.show("所有贝位的"+e.rowNo+"行位(纵向)装载总箱重为："+a.number.round(d,2))}},{text:function(){return"所有贝位的"+e.tierNo+"层位(横向)装载总重"},iconCls:"",handler:function(){var c=b.baysContainer.find("table.bays-wrapper[bayNo] tr[tierNo="+e.tierNo+"] td[rowNo]").map(function(){return M(b,a(this))}),d=a.array.sum(c,function(a){return a&&a.box&&a.box.boxWeight&&a.bayCell&&!a.bayCell.hasClass("bay-cell-bigbox-next")?a.box.boxWeight:0});a.messager.show("所有贝位的"+e.tierNo+"层位(横向)装载总箱重为："+a.number.round(d,2))}},"-",{text:"当前贝位装载总重",iconCls:"",handler:function(){var c=b.getBay(),d=a.array.some(c,function(a){return a.bayCell.hasClass("bay-cell-bigbox-next")}),e=a.array.sum(c,function(a){return a&&a.box&&a.box.boxWeight&&a.bayCell&&!a.bayCell.hasClass("bay-cell-bigbox-next")?a.box.boxWeight:0});a.messager.show("当前贝位装载总箱重为："+a.number.round(e,2)+(d?'<br/><span style="font-weight: bold; color: green">不包含在上一贝位配载的40\'箱重</span>':""))}},{text:"所有贝位装载总重",iconCls:"icon-standard-sum",handler:function(){var c=b.getAll(),d=a.array.sum(c,function(a){return a&&a.box&&a.box.boxWeight&&a.bayCell&&!a.bayCell.hasClass("bay-cell-bigbox-next")?a.box.boxWeight:0});a.messager.show("当前船只装载总箱重为："+a.number.round(d,2))}},"-",{text:"所有贝位装载总数",iconCls:"",handler:function(){var c=b.getAll(),d=a.array.sum(c,function(a){return a&&a.box&&a.bayCell&&!a.bayCell.hasClass("bay-cell-bigbox-next")?1:0});a.messager.show("当前船只装载总箱数为："+a.number.round(d,2))}}],a.easyui.showMenu({items:g,left:c.pageX,top:c.pageY}))}}).droppable({accept:"span.bay-row-draggable",onDrop:function(c,d){var e=a(d).closest("tr.datagrid-row"),f=parseInt(e.attr("datagrid-row-index")),g=b.boxesGrid.datagrid("getRows")[f],h=M(b,a(this));b.setCell(h.bayCellNo,g,!1,!0)}})}function i(a){return a}function j(b){var c=a.isArray(b)?b:[];return a.each(c,function(b,c){c.tiers=a.isArray(c.tiers)?c.tiers:[],a.each(c.tiers,function(b,c){c.rows=a.isArray(c.rows)?c.rows:[],c.bays=c.rows})}),c}function k(a){return a}function l(b,c,d){var e=c;return e=d?a("<span>"+d.bayCellNo+"&nbsp;箱号："+d.boxNo+"&nbsp;箱型："+d.boxSpec+d.boxType+d.boxState+"&nbsp;箱重："+d.boxWeight+"&nbsp;港口："+d.fromPort+"-"+d.toPort+"</span>"):c+"，未配载箱"}function m(b,c,d){return a("<span>"+d.fromPort+"-"+d.toPort+"</span><br/>"+'<span style="color: blue;">'+d.boxNo+"</span><br/>"+'<span style="color: green;">'+(d.boxSpec+d.boxType+"&nbsp;"+d.boxState)+'</span>/<span style="color: red;">'+d.boxWeight+"</span><br/>"+"<span>"+d.bayCellNo+"</span>")}function n(b,c,d){return d?a('<div style="width: 160px; height: 80px; line-height: 20px; font-size: 13px;"><span>'+d.fromPort+"-"+d.toPort+'</span><br/><span style="color: blue;">'+d.boxNo+'</span><br/><span style="color: green;">'+(d.boxSpec+d.boxType+"&nbsp;"+d.boxState)+'</span>/<span style="color: red;">'+d.boxWeight+'</span><br/><span style="float: right;">'+d.bayCellNo+"</span></div>"):c+"，未配载箱"}function o(b,c){return a.isArray(c)?(bay.boxesGrid.datagrid("loadData",c),void 0):window.alert("加载 BayGUI 左侧列表数据失败，传入的参数 data 不是一个数组对象")}function p(b,c){if(!a.isArray(c))return window.alert("初始化 BayGUI 组件失败，传入的参数 data 不是一个数组对象");if(!a.isFunction(b.onBeforeLoadBays)||0!=b.onBeforeLoadBays.call(b,c)){b.baysData=c;var d=b.baysContainer.empty().data("tabs",null).tabs({});a.each(c,function(c,e){var h,i,g=e.title="Bay"+e.bayNo+(e.isEdge?"##":"");d.tabs("add",{id:e.bayNo,title:g,closable:!1,selected:0==c,refreshable:!1}),h=d.tabs("tabs"),i=a.array.first(h,function(a){return a.panel("options").id==e.bayNo}),i&&f(b,i,e)}),a.isFunction(b.onLoadBays)&&b.onLoadBays.call(b,c)}}function q(b,c){function e(){a.array.sort(d,function(b,c){var d=a.string.left(b.bayCellNo,2),e=b.bayCellNo.substr(2,2),f=a.string.right(b.bayCellNo,2),g=a.string.left(c.bayCellNo,2),h=c.bayCellNo.substr(2,2),i=a.string.right(c.bayCellNo,2);return d=parseInt(d),e=parseInt(e),f=parseInt(f),g=parseInt(g),h=parseInt(h),i=parseInt(i),d==g?e==h?f-i:e-h:d-g});var c=b.floating,e=b.crushCasc;b.floating=!0,b.crushCasc=!0,a.each(d,function(a,c){E(b,c.bayCellNo,c,!1,!1,!0)}),b.floating=c,b.crushCasc=e}var f,g,d=a.array.filter(c,function(b){return b.bayCellNo&&a.string.isString(b.bayCellNo)&&6==b.bayCellNo.length});d.length&&(d.length>10?(a.easyui.loading({msg:"正在渲染贝位图表格组件效果，请耐心等耐..."}),a.util.exec(function(){e(),a.easyui.loaded()},100)):e()),f=b.bayRowDnd?!0:!1,f&&(g=b.boxesGrid.datagrid("getPanel").find("div.datagrid-view div.datagrid-body table.datagrid-btable tr.datagrid-row"),r(g))}function r(b){b&&b.length&&b.find("span.bay-row-draggable").draggable({disabled:!1,revert:!0,cursor:"pointer",deltaX:5,deltaY:5,proxy:function(b){var c=a(b).closest("tr.datagrid-row").clone(),d=a("<table></table>").append(c);return a('<div class="bay-row-draggable-wrapper"></div>').append(d).appendTo("body").hide()},onBeforeDrag:function(a){return 1==a.which},onDrag:function(b){var c=b.pageX-b.data.startX,d=b.pageY-b.data.startY;Math.abs(c)+Math.abs(d)>10&&a(this).draggable("proxy").show()}}).off("click.baydnd").on("click.baydnd",function(){return!1})}function s(a,b){a.saveAs(a.saveUrl,b)}function t(b,c,d){var e,f,g,h;return c?(e=b.boxesGrid.datagrid("getRows"),f=a.array.map(e,function(a){return{id:a.id,bayCellNo:a.bayCellNo}}),a.isFunction(b.onBeforeSave)&&0==b.onBeforeSave.call(b,f,c)||(g=a.isFunction(b.saveDataFilter)?b.saveDataFilter:a.baygui.defaults.saveDataFilter,f=g.call(b,f),h=a.extend({url:c,type:b.saveMethod,data:f,success:function(){a.isFunction(d)&&d.apply(this,arguments),a.isFunction(b.onSave)&&b.onSave.call(b,f,c)},error:function(){a.isFunction(b.onSaveError)&&b.onSaveError.apply(this,arguments)}},b.saveAjaxOptions),a.ajax(h)),void 0):a.messager.show("用于数据保存的远程服务器地址未设定，数据保存失败！")}function u(b,c){var d,e,f,g,h;return c&&a.string.isString(c)&&6==c.length?(d=a.string.left(c,2),e=c.substr(2,2),f=a.string.right(c,2),d=parseInt(d),0/0==d?null:(a.number.isOdd(d)||(d+=1),1==d?null:(g=a.string.padLeft(d-2,2,"0"),h=a.array.first(b.baysData,function(a){return a.bayNo==g}),!h||h.isEdge?null:b.getCellDom(g+e+f)))):null}function v(b,c){var d,e,f,g,h;return c&&a.string.isString(c)&&6==c.length?(d=a.string.left(c,2),e=c.substr(2,2),f=a.string.right(c,2),d=parseInt(d),0/0==d?null:(a.number.isOdd(d)||(d-=1),g=a.string.padLeft(d,2,"0"),h=a.array.first(b.baysData,function(a){return a.bayNo==g}),!h||h.isEdge?null:(d=a.string.padLeft(d+2,2,"0"),b.getCellDom(d+e+f)))):null}function w(b,c){if(!c||!a.string.isString(c)||6!=c.length)return null;var d=a.string.left(c,2),e=c.substr(2,2),f=a.string.right(c,2);return f=parseInt(f),0/0==f?null:(f=a.string.padLeft(f-2,2,"0"),b.getCellDom(d+e+f))}function x(b,c){var e,f,g,h,d=b.getCell(c);d&&(a.data(d.bayCell[0],"box-data",null),d.bayCell.find(">div.bay-cell-item").empty().append("<span>&nbsp;</span>"),e=d.box,e&&(e.bayCellNo&&(f=b.boxesGrid.datagrid("getRows"),g=a.array.filter(f,function(a){return a.bayCellNo==e.bayCellNo}),a.each(g,function(a,c){var e,d=b.boxesGrid.datagrid("getRowIndex",c);c.bayCellNo=null,b.boxesGrid.datagrid("updateRow",{index:d,row:c}).datagrid("unselectRow",d),b.bayRowDnd&&(e=b.boxesGrid.datagrid("getRowDom",d),r(e))})),"40"==e.boxSpec&&(h=d.bayCell.hasClass("bay-cell-bigbox-next")?u(b,d.bayCellNo):v(b,d.bayCellNo),h&&h&&(a.data(h[0],"box-data",null),h.removeClass("bay-cell-valued bay-cell-bigbox bay-cell-bigbox-next").find(">div.bay-cell-item").empty().append("<span>&nbsp;</span>")))),d.bayCell.removeClass("bay-cell-valued bay-cell-bigbox bay-cell-bigbox-next"),d.bayCell.hasClass("bay-cell-selected")&&b.selectCell(d.bayCellNo))}function y(b,c){a.each(b.getBay(c),function(a,c){b.clearCell(c.bayCellNo)})}function z(b){a.each(b.getAll(),function(a,c){b.clearCell(c.bayCellNo)})}function A(b,c){var d=a.string.isString(c)?a.array.first(b.boxesGrid.datagrid("getRows"),function(a){return a.boxNo==c}):c;d&&b.clearCell(d.bayCellNo)}function B(b,c){function k(){b.clearCell(d.bayCellNo);var c=a.data(d.bayCell[0],"box-data-inst"),e=a.data(d.bayCell[0],"box-data");c?e?c.boxNo!=e.boxNo&&E(b,d.bayCellNo,c,!1,!1,!1):E(b,d.bayCellNo,c,!1,!1,!1):e&&b.clearCell(d.bayCellNo)}var g,h,i,j,d=b.getCell(c),e=b.floating,f=b.crushCasc;d&&(b.floating=!0,b.crushCasc=!0,g=u(b,d.bayCellNo),g&&g.length?(h=M(b,g),h?(i=a.data(h.bayCell[0],"box-data-inst"),i&&"40"==i.boxSpec?(j=a.data(h.bayCell[0],"box-data"),j&&j.boxNo==i.boxNo||B(b,h.bayCellNo)):k()):k()):k(),b.floating=e,b.crushCasc=f)}function C(b,c){a.each(b.getBay(c),function(a,c){b.resetCell(c.bayCellNo)})}function D(b){a.each(b.getAll(),function(a,c){b.resetCell(c.bayCellNo)})}function E(c,d,e,f,g,h){function m(){h||x();var b=a.isFunction(c.cellFormatter)?c.cellFormatter:a.baygui.defaults.cellFormatter,e=i.bayCell.find(">div.bay-cell-item"),g=b.call(c,d,l,i.bayCell);e.empty()[a.string.isString(g)?"text":"append"](g),a.data(i.bayCell[0],"box-data",l),i.bayCell.addClass("bay-cell-valued"),f&&bay.jumpCell(i.bayCellNo),h&&a.data(i.bayCell[0],"box-data-inst",l),i.bayCell.hasClass("bay-cell-selected")&&c.selectCell(d),"40"==l.boxSpec&&y()}function n(){j||(j=w(c,i.bayCellNo)),k||(k=M(c,j))}function o(){return c.floating?!0:(n(),k&&!k.box?!1:!0)}function p(){return c.crushCasc||"40"==l.boxSpec?!0:(n(),k&&k.box&&"40"==k.box.boxSpec?!1:!0)}function q(){var a=v(c,i.bayCellNo),b=a&&a.length?M(c,a):null;return b&&b.box&&b.box.bayCellNo?!1:!0}function s(){var d,e,f,b=a.array.first(c.baysData,function(a){return a.bayNo==i.bayNo});return b?(d=parseInt(b.bayNo)+2,e=a.string.padLeft(d,2,"0"),f=a.array.first(c.baysData,function(a){return a.bayNo==e}),!f||b&&b.isEdge?!1:!0):!0}function t(){return i.disabled?!1:void 0}function u(){return l.bayCellNo?!1:void 0}function x(){var b,d,e,f;l.bayCellNo="40"==l.boxSpec?a.string.padLeft(parseInt(i.bayNo)+1,2,"0")+i.rowNo+i.tierNo:i.bayCellNo,b=c.boxesGrid.datagrid("options").idField,d=l[b],e=c.boxesGrid.datagrid("getRowIndex",d),a.isNumeric(e)&&(c.boxesGrid.datagrid("updateRow",{index:e,row:l}).datagrid("unselectRow",e),c.bayRowDnd&&(f=c.boxesGrid.datagrid("getRowDom",e),r(f)))}function y(){i.bayCell.addClass("bay-cell-bigbox");var a=v(c,i.bayCellNo);a&&a.length&&a.addClass("bay-cell-bigbox-next").find("div.bay-cell-item").empty().append("<span>"+l.boxNo+"</span><br/><span>该贝位已放置40'箱</span>")}if(d&&e){f=null!=f&&f!=b&&a.util.isBoolean(f)?f:!1,g=null!=g&&g!=b&&a.util.isBoolean(g)?g:!0,h=null!=h&&h!=b&&a.util.isBoolean(h)?h:!1;var j,k,i=c.getCell(d),l=a.string.isString(e)?a.array.first(c.boxesGrid.datagrid("getRows"),function(a){return a.boxNo==e}):e;if(i&&i.bayCell&&i.bayCell.length&&l){if(!h&&0==u())return a.messager.show("该箱已放置其他贝位；如需要重新放置，请先在表格的该箱所在行点击右键将其卸载");if(!h&&0==o())return a.messager.show('当前设置不允许架空配，请先设置该行位下方的贝位单元格，或启用"架空配"功能。');if(!h&&0==p())return a.messager.show("当前设置不20'箱架40'箱上，请更改放置方式，或启用\"20'箱架40'箱上\"功能。");if("40"==l.boxSpec){if(0==s())return a.messager.show("当前位置不允许放置 40' 箱，因为该贝位前侧无相邻贝位。");if(0==q())return a.messager.show("当前位置不允许放置 40' 箱，因为该贝位下一贝位的该位置已经放置了箱。")}return 0==t()?a.messager.show("当前位置不能放置箱，因为该贝位单元格不可用。"):(i.box?h?(c.clearCell(i.bayCellNo),m()):g?a.messager.confirm("操作提醒",a.string.format("当前贝位图单元格({0})已经设置了箱({1})，您是否要覆盖设置？",d,i.box.boxNo),function(a){a&&(c.clearCell(i.bayCellNo),m())}):(c.clearCell(i.bayCellNo),m()):m(),void 0)}}}function F(c,d,e,f,g){if(!a.isFunction(c.onBeforeSetCell)||0!=c.onBeforeSetCell.call(c,d,e,f,g)){var h=E(c,d,e,f,g,!1);null!=h&&h!=b||!a.isFunction(c.onSetCell)||c.onSetCell.call(c,d,e,f,g)}}function G(b,c){return a.isARray(c)?(a.each(c,function(a,c){b.setCell(c)}),void 0):a.messager.show("批量设置贝位装箱数据状态失败，传入的参数不是一组数组")}function H(b,c){var d,e,f;if(!a.isFunction(b.onBeforeSelectCell)||0!=b.onBeforeSelectCell.call(b,c)){if(d=b.getCell(c),!d)return a.messager.show("该贝位号所表示的单元格不存在");b.unSelectCell(),d.bayCell.addClass("bay-cell-selected"),e=a.isFunction(b.boardFormatter)?b.boardFormatter:a.baygui.defaults.boardFormatter,f=e.call(this,c,d.box),J(b,f),a.isFunction(b.onSelectCell)&&b.onSelectCell.call(b,c)}}function I(a){a.baysContainer.find("table.bays-wrapper[bayNo] tr[tierNo] td.bay-cell-selected[rowNo]").removeClass("bay-cell-selected"),J(a)}function J(b,c){c=c||"当前没有选中任何贝位单元格",b.bayCellBoard&&b.bayCellBoard.length&&b.bayCellBoard.each(function(){a.html5.testProp("value",this.tagName)?a(this).val(a.string.isString(c)?c:a(c).text()):a(this).empty()[a.string.isString(c)?"text":"append"](c)})}function K(a,b){var c=a.getCellDom(b);return M(a,c)}function L(b,c){var d,e,f,g,h,i;return c?a.util.isString(c)&&6==c.length?(d=a.string.left(c,2),e=c.substr(2,2),f=a.string.right(c,2),a.number.isOdd(d)?b.baysContainer.find("table.bays-wrapper[bayNo="+d+"] tr[tierNo="+f+"] td[rowNo="+e+"]"):(g=parseInt(d),h=b.baysContainer.find("table.bays-wrapper[bayNo="+a.string.padLeft(g-1,2,"0")+"] tr[tierNo="+f+"] td[rowNo="+e+"]"),i=b.baysContainer.find("table.bays-wrapper[bayNo="+a.string.padLeft(g+1,2,"0")+"] tr[tierNo="+f+"] td[rowNo="+e+"]"),h.add(i))):a.messager.show("传入的是一个不合法的贝位号"):N(b)}function M(b,c){var j,d,e,f,g,h,i,k,l;return c&&c.length&&c.is("td[rowNo]")?(c=a(c[0]),d=c.closest("tr.bay-row[tierNo]"),e=d.closest("table.bays-wrapper[bayNo]"),f=e.attr("bayNo"),g=d.attr("tierNo"),h=c.attr("rowNo"),i=f+h+g,k=c.attr("disabled")?!0:!1,c.hasClass("bay-cell-bigbox-next")?(l=u(b,i),l&&l.length&&(j=a.data(l[0],"box-data"))):j=a.data(c[0],"box-data"),{bayNo:f,tierNo:g,rowNo:h,bayCellNo:i,bayCell:c,disabled:k,box:j}):null}function N(a){return a.baysContainer.find("table.bays-wrapper[bayNo] tr[tierNo] td[rowNo].bay-cell-selected")}function O(b,c){var d=c?b.baysContainer.find("table.bays-wrapper[bayNo="+c+"]"):Q(b);return d.find("tr[tierNo] td[rowNo]").map(function(){return M(b,a(this))})}function P(b){return b.baysContainer.find("table.bays-wrapper[bayNo] tr[tierNo] td[rowNo]").map(function(){return M(b,a(this))})}function Q(a){return R(a).find("table.bays-wrapper[bayNo]")}function R(a){return a.baysContainer.tabs("getSelected").panel("body")}function S(b,c){if(!a.util.isString(c)||6!=c.length)return a.messager.show("传入的是一个不合法的贝位号");var d=a.string.left(c,2);b.jumpBay(d),b.selectCell(c)}function T(b,c){var d,e,f;return c?(c=parseInt(c),a.number.isOdd(c)||(c-=1),c=a.string.padLeft(c,2,"0"),d=b.baysContainer.tabs("tabs"),e=a.array.first(d,function(a){return a.panel("options").id==c}),e&&(f=b.baysContainer.tabs("getTabIndex",e),b.baysContainer.tabs("select",f)),void 0):a.messager.show("传入的是一个不合法的贝号")}a.util.namespace("$.baygui"),a.baygui.init=function(b){return new a.baygui.init.prototype.inst(b)},a.baygui.inst=function(c){var d=this,e=a.extend({},a.baygui.defaults,c||{});return e.boxesGrid=e.boxesGrid?a.util.parseJquery(e.boxesGrid):null,e.baysContainer=e.baysContainer?a.util.parseJquery(e.baysContainer):null,e.bayCellBoard=e.bayCellBoard?a.util.parseJquery(e.bayCellBoard).addClass("bays-selected-label"):null,e.boxesGrid&&e.boxesGrid.length&&e.baysContainer&&e.baysContainer.length?(e.columnFilter=null,a[e.baysMethod.toLowerCase()](e.baysUrl,e.baysQueryParams,function(c){var g,h,f=a.isFunction(d.baysDataFilter)?d.baysDataFilter:a.baygui.defaults.baysDataFilter;c=f.call(d,c),d.loadBays(c),g=e.boxesColumns,a.isArray(g)||(g=[[]]),d.bayRowDnd&&g[0].push({field:"boxDrag",title:"拖动",width:55,align:"center",formatter:function(){return'<span class="bay-row-draggable icon-hamburg-exchange">拖动</span>'}}),h=a.extend({url:e.boxesUrl,method:e.boxesMethod,queryParams:e.boxesQueryParams,columns:g},a.fn.datagrid.parseOptions(e.boxesGrid[0]),{idField:"id",remoteSort:!1,singleSelect:!0,selectOnCheck:!1,checkOnSelect:!1,pagination:!1,refreshMenu:!1,enableHeaderContextMenu:!0,enableHeaderClickMenu:!1,selectOnRowContextMenu:!0,columnFilter:e.columnFilter,rowContextMenu:[{text:"设置贝位",iconCls:"icon-hamburg-exchange",disabled:function(a,b,c){return c.bayCellNo?!0:!1},handler:function(b,c,e){var f=d.getCell();return f?(d.setCell(f.bayCellNo,e,!1,!0),void 0):a.messager.show("请先选中一个贝位图单元格！")}},{text:"卸载此箱",iconCls:"icon-standard-cancel",disabled:function(a,b,c){return c.bayCellNo?!1:!0},handler:function(a,b,c){return d.clearBoxCell(c)}},"-",{text:"定位此贝位单元格",disabled:function(b,c,d){return d&&d.bayCellNo&&a.string.isString(d.bayCellNo)&&6==d.bayCellNo.length?!1:!0},handler:function(a,b,c){d.jumpCell(c.bayCellNo)}},"-",{text:"总数量合计",iconCls:"",handler:function(){var b=d.boxesGrid.datagrid("getRows"),c=b&&a.isArray(b)?b.length:0;a.messager.show("总箱数为："+a.number.round(c,2))}},{text:"已装载总数合计",iconCls:"",handler:function(){var b=d.boxesGrid.datagrid("getRows"),c=a.array.sum(b,function(b){return b&&b.bayCellNo&&a.string.isString(b.bayCellNo)&&6==b.bayCellNo.length?1:0});a.messager.show("已装载的总箱数为："+a.number.round(c,2))}},{text:"未装载总数合计",iconCls:"",handler:function(){var b=d.boxesGrid.datagrid("getRows"),c=a.array.sum(b,function(b){return!b||b.bayCellNo&&a.string.isString(b.bayCellNo)&&6==b.bayCellNo.length?0:1});a.messager.show("未装载的总箱数为："+a.number.round(c,2))}},"-",{text:"总重量合计",iconCls:"icon-standard-sum",handler:function(){var c=d.boxesGrid.datagrid("getRows"),e=a.array.sum(c,function(a){var c=null==a.boxWeight||a.boxWeight==b?0:window.parseFloat(a.boxWeight);return 0/0==c&&(c=0),a.boxWeight});a.messager.show("总箱重为："+a.number.round(e,2))}},{text:"已装载总重合计",iconCls:"",handler:function(){var b=d.boxesGrid.datagrid("getRows"),c=a.array.sum(b,function(b){return b&&b.bayCellNo&&a.string.isString(b.bayCellNo)&&6==b.bayCellNo.length&&b.boxWeight?b.boxWeight:0});a.messager.show("已装载总箱重为："+a.number.round(c,2))}},{text:"未装载总重合计",iconCls:"",handler:function(){var b=d.boxesGrid.datagrid("getRows"),c=a.array.sum(b,function(b){return!b||b.bayCellNo&&a.string.isString(b.bayCellNo)&&6==b.bayCellNo.length||!b.boxWeight?0:b.boxWeight});a.messager.show("未装载总箱重为："+a.number.round(c,2))}}],loadFilter:function(b){var c=a.isFunction(d.gridDataFilter)?d.gridDataFilter:a.baygui.defaults.gridDataFilter,b=c.call(d,b);return a.fn.datagrid.defaults.loadFilter.call(this,b)},onLoadSuccess:function(b){a.fn.datagrid.extensions.defaults.onLoadSuccess.apply(this,arguments),b=b?a.isArray(b)?b:b.rows:[],d.instBoxesState(b),a.isFunction(d.onLoadBoxes)&&d.onLoadBoxes.call(d,b)}}),e.boxesGrid.datagrid(h)},"json"),a.extend(this,e)):null},a.baygui.methods={loadBoxes:function(a){return o(this,a)},loadBays:function(a){return p(this,a)},instBoxesState:function(a){return q(this,a)},save:function(a){return s(this,a)},saveAs:function(a,b){return t(this,a,b)},getCell:function(a){return K(this,a)},getCellDom:function(a){return L(this,a)},getBay:function(a){return O(this,a)},getAll:function(){return P(this)},resetCell:function(a){return B(this,a)},resetBay:function(a){return C(this,a)},resetAll:function(){return D(this)},clearCell:function(a){return x(this,a)},clearBay:function(a){return y(this,a)},clearAll:function(){return z(this)},clearBoxCell:function(a){return A(this,a)},setCell:function(a,b,c,d){return F(this,a,b,c,d)},setCells:function(a){return G(this,a)},selectCell:function(a){return H(this,a)},unSelectCell:function(){return I(this)},jumpCell:function(a){return S(this,a)},jumpBay:function(a){return T(this,a)}},a.baygui.defaults={boxesGrid:null,boxesUrl:null,boxesMethod:"post",boxesQueryParams:null,baysContainer:null,baysUrl:null,baysQueryParams:null,baysMethod:"post",floating:!1,crushCasc:!1,bayCellTooltip:!0,bayCellContextMenu:!0,bayRowDnd:!0,bayCellBoard:null,saveUrl:null,saveMethod:"post",boardFormatter:function(a,b){return l(this,a,b)},cellFormatter:function(a,b,c){return m(this,a,b,c)},tooltipFormatter:function(a,b,c){return n(this,a,b,c)},gridDataFilter:function(a){return i.call(this,a)},baysDataFilter:function(a){return j.call(this,a)},saveDataFilter:function(a){return k.call(this,a)},onLoadBoxes:function(){},onBeforeLoadBays:function(){},onLoadBays:function(){},onBeforeSave:function(){},onSave:function(){},onBeforeSetCell:function(){},onSetCell:function(){},onBeforeSelectCell:function(){},onSelectCell:function(){},cell:{width:85,height:60,ruleXH:25,ruleYW:30}},a.extend(a.baygui.init.prototype=a.baygui.inst.prototype,{inst:a.baygui.inst},a.baygui.methods,a.baygui.defaults);var U=".bays-container { margin: 0px auto; position: absolute; display: table; }.bays-wrapper { padding: 0px; margin: 0px; border-width: 0px; }.bay-row { height: "+a.baygui.defaults.cell.height+"px; }"+".bay-cell-rulex, .bay-cell-ruley, .bay-cell-indent { background-color: #efefef; background: linear-gradient(to bottom,#F9F9F9 0,#efefef 100%); background-repeat: repeat-x; }"+".bay-cell, .bay-cell-indent { width: "+a.baygui.defaults.cell.width+"px; padding: 0px; margin: 0px; border-top-width: 0px; border-left-width: 0px; border-bottom-width: 1px; border-right-width: 1px; border-color: #ccc; border-style: dotted; }"+".bay-cell-rulex, .bay-cell-ruley, .bay-cell-indent { text-align: center; }"+".bay-cell-rulex { height: "+a.baygui.defaults.cell.ruleXH+"px; }"+".bay-cell-ruley { width: "+a.baygui.defaults.cell.ruleYW+"px; }"+".bay-cell-indent-half { width: "+a.baygui.defaults.cell.width/2+"px; }"+".bay-cell-item { margin: 0px; padding: 0px; width: "+(a.baygui.defaults.cell.width-4)+"px; height: auto; white-space: nowrap; word-wrap: normal; overflow: hidden; line-height: 14px; }"+".bay-cell-disabled { background-color: gray; }"+".bay-cell-valued { background-color: #DFDFDF; }"+".bay-cell-bigbox { background-color: #999999; }"+".bay-cell-bigbox-next { background-color: #2C2D2D; color: white; }"+".bay-cell-selected { background-color: #89be89; }"+".bays-selected-label { font-weight: bold; color: green; }"+".bay-row-draggable { padding: 2px 4px 2px 18px; background-position: left center; }"+".bay-row-draggable:hover { border-width: 1px; border-style: solid; border-color: #9EC22D; }"+".bay-row-draggable-wrapper { border-width: 1px; border-style: solid; border-color: blue: }";a.util.addCss(U)}(jQuery);